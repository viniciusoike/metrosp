# metrosp

R data package providing Sao Paulo Metro (METRO SP) passenger demand data (2017-2025).
Similar to nycflights13: datasets only, no user-facing functions.

## Package Structure

```
metrosp/
├── R/data.R                    # Roxygen2 docs for all exported datasets (NO functions)
├── data/*.rda                  # Lazy-loaded datasets (the package deliverable)
├── data-raw/                   # ETL pipeline (not shipped with package)
│   ├── make_datasets.R         # Master script: harmonize schemas + create .rda files
│   ├── utils.R                 # Shared dimension tables and utility functions
│   ├── download_metro.R        # Downloads raw data from METRO transparency portal
│   ├── import_passenger_2017_19.R      # Passenger data ETL (2017-2019)
│   ├── import_daily_2017_19.R          # Station averages ETL (2017-2019)
│   ├── import_passengers_entrance.R    # Passenger entrance ETL (2020-2025)
│   ├── import_passengers_transported.R # Passenger transported ETL (2020-2025)
│   ├── import_station_averages.R       # Station averages ETL (2020-2025)
│   ├── import_station_daily.R          # INCOMPLETE: daily station data
│   ├── import_geosampa.R              # GeoSampa spatial data ETL (metro + train)
│   ├── geosampa/               # GeoSampa GPKG source files (9 files)
│   ├── processed/              # Intermediate CSVs (committed to git, ~600KB)
│   └── metro_sp/               # Raw source files (gitignored, ~46MB)
├── tests/testthat/
├── vignettes/
├── DESCRIPTION
├── NAMESPACE                   # Auto-generated by roxygen2
└── PLAN.md                     # Development plan
```

## Exported Datasets

| Dataset | Description |
|---|---|
| `passengers_entrance` | Monthly passenger entries by metro line (2017-2025) |
| `passengers_transported` | Monthly passengers transported by metro line (2017-2025) |
| `station_averages` | Average weekday passenger entries by station (2017-2025) |
| `metro_lines` | Reference table: line number, Portuguese/English names |
| `metro_lines_geo` | Metro line route geometries (sf, current + planned) |
| `metro_stations_geo` | Metro station point locations (sf, current + planned) |
| `train_lines` | Reference table: CPTM train line numbers and names |
| `train_lines_geo` | CPTM train line route geometries (sf, current + planned) |
| `train_stations_geo` | CPTM train station point locations (sf, current + planned) |

## Key Rules

- This is a **data-only package**. `R/` should contain ONLY `data.R` (documentation). No functions.
- To update datasets: edit ETL scripts in `data-raw/`, then run `source("data-raw/make_datasets.R")`
- `data-raw/metro_sp/` is gitignored (46MB raw files). Never commit it.
- `data-raw/processed/` IS committed (intermediate CSVs, ~600KB)
- The 2017-2019 and 2020-2025 CSVs have different column schemas. `make_datasets.R` handles harmonization.

## Data Sources

- Passenger demand data: https://transparencia.metrosp.com.br/dataset/demanda (Companhia do Metropolitano de Sao Paulo)
- Spatial data (lines/stations): https://geosampa.prefeitura.sp.gov.br/ (Prefeitura de Sao Paulo)

## Known Data Gaps

- **Line 5 (Lilas)**: Available in 2017-2019, missing from 2020-2025
- **2017**: Only Oct-Dec available (not full year)
- **2025**: Trailing months may have NA values (data not yet published)
- **Daily station data**: Raw CSVs exist but import script is incomplete (not in v0.1.0)
- **Station metrics**: Only weekday average (mdu) available at station level

## Development Workflow

1. Raw data is downloaded via `data-raw/download_metro.R` into `data-raw/metro_sp/`
2. Individual import scripts process raw CSVs into `data-raw/processed/` intermediates
3. `data-raw/make_datasets.R` reads intermediates, harmonizes schemas, merges periods, and creates `.rda` files in `data/`
4. `devtools::document()` generates man pages from `R/data.R`
5. `devtools::check()` validates the package
